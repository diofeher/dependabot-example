name: Backport

on:
  workflow_dispatch:
    inputs:
      pull_request:
        description: "Number of the pull request"
        required: true
        type: number
      branch:
        description: "Target branch"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  backport:
    name: Backport PR
    runs-on: ubuntu-latest
    steps:
      - name: Set up
        id: extract-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          PR_NUMBER="${{ inputs.pull_request }}"
          TARGET_BRANCH="${{ inputs.branch }}"

          echo "Validating PR #$PR_NUMBER..."

          # Validate PR exists and is valid
          if ! gh pr view "$PR_NUMBER" --json number,state | cat >/dev/null 2>&1; then
            echo "❌ Error: PR #$PR_NUMBER not found or invalid"
            exit 1
          fi

          echo "✅ PR #$PR_NUMBER exists"

          echo "Validating target branch '$TARGET_BRANCH'..."

          # Validate target branch exists
          if ! gh api "repos/:owner/:repo/git/refs/heads/$TARGET_BRANCH" >/dev/null 2>&1; then
            echo "❌ Error: Branch '$TARGET_BRANCH' does not exist"
            exit 1
          fi

          echo "✅ Branch '$TARGET_BRANCH' exists"

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create backport branch and cherry-pick
        id: cherry-pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          PR_NUMBER="${{ steps.extract-branch.outputs.pr_number }}"
          TARGET_BRANCH="${{ steps.extract-branch.outputs.target_branch }}"
          BACKPORT_BRANCH="backport-${PR_NUMBER}-to-${TARGET_BRANCH}"

          echo "Processing PR #$PR_NUMBER for backport to $TARGET_BRANCH"

          # Fetch and checkout target branch
          git fetch origin "$TARGET_BRANCH"
          git checkout -b "$BACKPORT_BRANCH" "origin/$TARGET_BRANCH"

          # Get all commits from the PR using gh CLI
          PR_COMMITS=$(gh pr view "$PR_NUMBER" --json commits --jq '.commits[].oid')

          echo "Commits to cherry-pick:"
          echo "$PR_COMMITS"

          # Cherry-pick each commit
          CONFLICT=false
          for commit in $PR_COMMITS; do
            if ! git cherry-pick -s "$commit"; then
              echo "Cherry-pick failed for commit $commit"
              CONFLICT=true
              break
            fi
          done

          if [ "$CONFLICT" = true ]; then
            git cherry-pick --abort || true
            echo "conflict=true" >> $GITHUB_OUTPUT
            echo "branch=$BACKPORT_BRANCH" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Push the backport branch
          git push origin "$BACKPORT_BRANCH"

          echo "branch=$BACKPORT_BRANCH" >> $GITHUB_OUTPUT
          echo "conflict=false" >> $GITHUB_OUTPUT

      - name: Create backport PR
        if: steps.cherry-pick.outputs.conflict != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TARGET_BRANCH="${{ steps.extract-branch.outputs.target_branch }}"
          BACKPORT_BRANCH="${{ steps.cherry-pick.outputs.branch }}"
          ORIGINAL_PR="${{ steps.extract-branch.outputs.pr_number }}"

          # Get original PR details using gh CLI
          ORIGINAL_TITLE=$(gh pr view "$ORIGINAL_PR" --json title --jq '.title')
          ORIGINAL_AUTHOR=$(gh pr view "$ORIGINAL_PR" --json author --jq '.author.login')

          gh pr create \
            --title "[Backport to $TARGET_BRANCH] $ORIGINAL_TITLE" \
            --body "Backport of #$ORIGINAL_PR to \`$TARGET_BRANCH\`

          ---

          Original PR: #$ORIGINAL_PR
          Original Author: @$ORIGINAL_AUTHOR

          This PR was automatically created by the backport workflow." \
            --base "$TARGET_BRANCH" \
            --head "$BACKPORT_BRANCH"

      - name: Comment on original PR (success)
        if: steps.cherry-pick.outputs.conflict != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TARGET_BRANCH="${{ steps.extract-branch.outputs.target_branch }}"
          BACKPORT_BRANCH="${{ steps.cherry-pick.outputs.branch }}"
          ORIGINAL_PR="${{ steps.extract-branch.outputs.pr_number }}"

          gh pr comment "$ORIGINAL_PR" \
            --body "✅ Backport PR created successfully for branch \`$TARGET_BRANCH\`: branch \`$BACKPORT_BRANCH\`"

      - name: Comment on original PR (conflict)
        if: steps.cherry-pick.outputs.conflict == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TARGET_BRANCH="${{ steps.extract-branch.outputs.target_branch }}"
          ORIGINAL_PR="${{ steps.extract-branch.outputs.pr_number }}"

          gh pr comment "$ORIGINAL_PR" \
            --body "❌ Automated backport to \`$TARGET_BRANCH\` failed due to conflicts. Please backport manually."
